From a0fd4cd595bd0fe6eb4015ea9050170319b16546 Mon Sep 17 00:00:00 2001
From: Debarshi Ray <debarshir@gnome.org>
Date: Wed, 19 Jun 2013 15:04:38 +0000
Subject: google: Export CalDAV and CardDAV endpoints

According to:
https://developers.google.com/google-apps/calendar/caldav/v2/guide/
https://developers.google.com/google-apps/carddav/

See: https://bugzilla.gnome.org/show_bug.cgi?id=686804
     https://bugzilla.gnome.org/show_bug.cgi?id=688364
---
(limited to 'src/goabackend/goagoogleprovider.c')

Index: gnome-online-accounts-3.8.3/src/goabackend/goagoogleprovider.c
===================================================================
--- gnome-online-accounts-3.8.3.orig/src/goabackend/goagoogleprovider.c	2013-09-19 18:58:41.779813493 +0200
+++ gnome-online-accounts-3.8.3/src/goabackend/goagoogleprovider.c	2013-09-19 18:58:41.779813493 +0200
@@ -374,6 +374,7 @@
   gboolean contacts_enabled;
   gboolean chat_enabled;
   gboolean documents_enabled;
+  const gchar *email_address;
 
   account = NULL;
   mail = NULL;
@@ -408,6 +409,7 @@
     }
 
   account = goa_object_get_account (GOA_OBJECT (object));
+  email_address = goa_account_get_identity (account);
 
   /* Email */
   mail = goa_object_get_mail (GOA_OBJECT (object));
@@ -416,8 +418,6 @@
     {
       if (mail == NULL)
         {
-          const gchar *email_address;
-          email_address = goa_account_get_identity (account);
           mail = goa_mail_skeleton_new ();
           g_object_set (G_OBJECT (mail),
                         "email-address",   email_address,
@@ -446,8 +446,19 @@
     {
       if (calendar == NULL)
         {
+          gchar *uri_caldav;
+
+          uri_caldav = g_strconcat ("https://apidata.googleusercontent.com/caldav/v2/",
+                                    email_address,
+                                    "/user",
+                                    NULL);
+
           calendar = goa_calendar_skeleton_new ();
+          g_object_set (G_OBJECT (calendar),
+                        "uri", uri_caldav,
+                        NULL);
           goa_object_skeleton_set_calendar (object, calendar);
+          g_free (uri_caldav);
         }
     }
   else
@@ -464,6 +475,9 @@
       if (contacts == NULL)
         {
           contacts = goa_contacts_skeleton_new ();
+          g_object_set (G_OBJECT (contacts),
+                        "uri", "https://www.googleapis.com/.well-known/carddav",
+                        NULL);
           goa_object_skeleton_set_contacts (object, contacts);
         }
     }
